<%- include('../../partials/header') %>

<div class="container py-5">

  <!-- âœ… Ø¹Ù†ÙˆØ§Ù† Ø£Ù†ÙŠÙ‚ -->
  <div class="mb-5 text-center">
    <h1 class="fw-bold display-5 mb-2" style="color: #0d6efd;">
      ğŸ“ Call Reports Dashboard
    </h1>
   <p class="text-muted fs-5 mb-0">


  <small>
    ğŸ“… Date: <%= query.date || new Date().toISOString().split('T')[0] %> | 
    ğŸ‘¤ Employee: 
    <% 
      const selectedUser = users.find(u => u._id.toString() === (query.employee_id || '')); 
    %>
    <%= selectedUser ? selectedUser.name : 'All Employees' %>
  </small>
</p>

  </div>

  <!-- âœ… Ù…Ø±Ø¨Ø¹Ø§Øª Info -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="bg-primary bg-gradient text-white rounded-4 shadow-sm p-3 text-center">
        <h6>Total Calls</h6>
        <h3><%= callReports.length + overdueCalls.length %></h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="bg-success bg-gradient text-white rounded-4 shadow-sm p-3 text-center">
        <h6>Filtered Calls</h6>
        <h3><%= callReports.length %></h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="bg-danger bg-gradient text-white rounded-4 shadow-sm p-3 text-center">
        <h6>Overdue Calls</h6>
        <h3><%= overdueCalls.length %></h3>
      </div>
    </div>
  </div>

  <!-- âœ… ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø« -->
  <form method="GET" class="row g-3 align-items-end mb-5 bg-white border rounded-4 shadow-sm p-4">
    <div class="col-md-4">
      <label class="form-label fw-semibold">ğŸ‘¤ Employee</label>
      <select name="employee_id" class="form-select rounded-pill shadow-sm">
        <option value="">All Employees</option>
        <% users.forEach(u => { %>
          <option value="<%= u._id %>"
            <%= u._id.toString() === (query.employee_id || '') ? 'selected' : '' %> >
            <%= u.name %>
          </option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label fw-semibold">ğŸ“… Date</label>
     <input type="date" name="date" class="form-control rounded-pill shadow-sm"
  value="<%= query.date || new Date().toISOString().split('T')[0] %>">

    </div>
    <div class="col-md-4 d-grid">
      <button type="submit" class="btn btn-primary rounded-pill fw-bold shadow-sm">
        ğŸ” Apply Filter
      </button>
    </div>
  </form>

  <!-- âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© -->
  <% if (callReports.length > 0) { %>
    <h5 class="fw-bold mb-3">âœ… Filtered Call Reports</h5>
   <div class="table-responsive shadow-sm rounded-4 overflow-hidden mb-5">
  <table class="table table-striped table-hover align-middle mb-0" style="border-collapse: separate; border-spacing: 0;">
    <thead class="table-primary text-center text-white fw-bold" style="background: #0d6efd;">
      <tr>
        <th class="px-3 py-3">ğŸ‘¤ Employee</th>
        <th class="px-3 py-3">ğŸ§‘â€ğŸ’¼ Client</th>
        <th class="px-3 py-3">â˜ï¸ Phone</th>
        <th class="px-3 py-3">ğŸŒ Source</th>
        <th class="px-3 py-3">ğŸ“£ Answered</th>
        <th class="px-3 py-3">âš¡ Action</th>
        <th class="px-3 py-3">ğŸ” Follow-Ups</th>
        <th class="px-3 py-3">â° Overdue</th>
        <th class="px-3 py-3">âœ… Done</th>
        <th class="px-3 py-3">ğŸ“… Call Date</th>
        <th class="px-3 py-3">ğŸ“œ Timeline</th>
      </tr>
    </thead>
    <tbody class="text-center">
      <% callReports.forEach(report => { %>
        <tr class="<%= report.overdue ? 'table-warning' : '' %>" style="transition: background 0.3s;">
          <td class="px-3 py-2 text-start fw-semibold">
            <%= report.employee_id?.name || 'N/A' %>
          </td>
          <td class="px-3 py-2"><%= report.client_name || '-' %></td>
          <td class="px-3 py-2"><%= report.phone_number %></td>
          <td class="px-3 py-2">
            <span class="badge rounded-pill shadow-sm 
              <% if (report.source === 'dubizzle') { %> bg-danger 
              <% } else if (report.source === 'bayut') { %> bg-success 
              <% } else if (report.source === 'meta') { %> bg-primary 
              <% } else if (report.source === 'PropertyFinder') { %> bg-warning text-dark 
              <% } else { %> bg-secondary <% } %>">
              <%= report.source %>
            </span>
          </td>
          <td class="px-3 py-2">
            <span class="badge rounded-pill shadow-sm <%= report.answered ? 'bg-success' : 'bg-danger' %>">
              <%= report.answered ? 'Yes' : 'No' %>
            </span>
          </td>
          <td class="px-3 py-2 text-start"><%= report.action %></td>
          <td class="px-3 py-2">
            <span class="badge rounded-pill shadow-sm <%= report.follow_up_logs.length > 0 ? 'bg-info' : 'bg-secondary' %>">
              <%= report.follow_up_logs.length %>
            </span>
          </td>
          <td class="px-3 py-2">
            <span class="badge rounded-pill shadow-sm <%= report.overdue ? 'bg-danger' : 'bg-success' %>">
              <%= report.overdue ? 'Yes' : 'No' %>
            </span>
          </td>
          <td class="px-3 py-2">
            <span class="badge rounded-pill shadow-sm <%= report.marked_done ? 'bg-success' : 'bg-warning text-dark' %>">
              <%= report.marked_done ? 'Done' : 'Pending' %>
            </span>
          </td>
          <td class="px-3 py-2"><%= report.call_date ? report.call_date.toLocaleDateString() : '-' %></td>
          <td class="px-3 py-2">
            <a href="/call-reports/<%= report._id %>/timeline" class="btn btn-sm btn-outline-info rounded-pill shadow-sm">
              ğŸ“œ View
            </a>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

  <% } else { %>
    <div class="alert alert-warning text-center fw-semibold py-4 shadow-sm mb-5">
      ğŸš« No Call Reports Found for your filter.
    </div>
  <% } %>

  <!-- âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© -->
  <% if (overdueCalls.length > 0) { %>
    <h5 class="fw-bold mb-3 text-danger">âš ï¸ Overdue Calls â€” Need Follow-Up!</h5>
    <div class="alert alert-danger fw-semibold mb-4 shadow-sm">
      âš ï¸ There are <%= overdueCalls.length %> overdue calls that need urgent follow-up!
    </div>
    <div class="table-responsive shadow-sm rounded-4 overflow-hidden">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-danger text-center">
          <tr>
            <th>ğŸ‘¤ Employee</th>
            <th>ğŸ§‘â€ğŸ’¼ Client</th>
            <th>â˜ï¸ Phone</th>
            <th>ğŸŒ Source</th>
            <th>âš¡ Action</th>
            <th>ğŸ” Follow-Ups</th>
            <th>ğŸ•’ Last Follow-Up</th>
            <th>ğŸ“… Call Date</th>
            <th>â° Days Ago</th>
            <th>ğŸ“œ Timeline</th>
          </tr>
        </thead>
        <tbody class="text-center">
          <% overdueCalls.forEach(call => { %>
            <tr>
              <td class="text-start fw-semibold"><%= call.employee_id?.name || 'N/A' %></td>
              <td><%= call.client_name || '-' %></td>
              <td><%= call.phone_number %></td>
              <td>
                <span class="badge rounded-pill shadow-sm 
                <% if (call.source === 'dubizzle') { %> bg-danger 
                <% } else if (call.source === 'bayut') { %> bg-success 
                <% } else if (call.source === 'meta') { %> bg-primary 
                <% } else if (call.source === 'PropertyFinder') { %> bg-warning text-dark 
                <% } else { %> bg-secondary <% } %>">
                  <%= call.source %>
                </span>
              </td>
              <td class="text-start"><%= call.action %></td>
              <td>
                <span class="badge rounded-pill shadow-sm <%= call.follow_up_logs && call.follow_up_logs.length > 0 ? 'bg-info' : 'bg-secondary' %>">
                  <%= call.follow_up_logs ? call.follow_up_logs.length : 0 %>
                </span>
              </td>
              <td><%= call.last_follow_up ? new Date(call.last_follow_up).toLocaleDateString() : '-' %></td>
              <td><%= call.call_date ? call.call_date.toLocaleDateString() : '-' %></td>
              <td><%= Math.floor((new Date() - new Date(call.call_date)) / (1000 * 60 * 60 * 24)) %> days</td>
              <td>
                <a href="/call-reports/<%= call._id %>/timeline" class="btn btn-sm btn-outline-info rounded-pill shadow-sm">
                  ğŸ“œ View
                </a>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } else { %>
    <div class="alert alert-success text-center fw-semibold py-4 shadow-sm">
      âœ… No Overdue Calls Found! ğŸ‰
    </div>
  <% } %>

</div>

<%- include('../../partials/footer') %>
