<%- include('partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-primary">üóÇÔ∏è Offices in Branch</h1>
    <a href="/offices/new?branch_id=<%= branchId %>" class="btn btn-success">
        ‚ûï Add New Office
    </a>
</div>

<!-- Filter -->
<form method="GET" action="/bookings/branch/<%= branchId %>" class="mb-4">
    <div class="row g-3 align-items-center">
        <div class="col-auto">
            <label class="col-form-label">Filter:</label>
        </div>
        <div class="col-auto">
            <select name="filter" class="form-select" onchange="this.form.submit()">
                <option value="all" <%= filter === 'all' ? 'selected' : '' %>>Show All</option>
                <option value="available" <%= filter === 'available' ? 'selected' : '' %>>Show Only Available</option>
                <option value="booked" <%= filter === 'booked' ? 'selected' : '' %>>Show Only Booked</option>
            </select>
        </div>
    </div>
</form>

<!-- Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center bg-primary text-white shadow">
            <div class="card-body">
                <h5 class="card-title">Total Offices</h5>
                <h2><%= totalOffices %></h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-success text-white shadow">
            <div class="card-body">
                <h5 class="card-title">Available Offices</h5>
                <h2><%= totalAvailable %></h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-danger text-white shadow">
            <div class="card-body">
                <h5 class="card-title">Booked Offices</h5>
                <h2><%= totalBooked %></h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-warning text-dark shadow">
            <div class="card-body">
                <h5 class="card-title">Expiring This Month</h5>
                <h2><%= expiringThisMonth %></h2>
            </div>
        </div>
    </div>
</div>

<!-- Chart -->
<div class="text-center mb-4">
    <h5>üìä Office Occupancy</h5>
    <div style="max-width: 300px; margin: 0 auto;">
        <canvas id="occupancyChart"></canvas>
    </div>
</div>

<script>
    const occupancyCtx = document.getElementById('occupancyChart').getContext('2d');
    const occupancyChart = new Chart(occupancyCtx, {
        type: 'pie',
        data: {
            labels: ['Booked', 'Available'],
            datasets: [{
                data: [<%= totalBooked %>, <%= totalAvailable %>],
                backgroundColor: ['rgba(255, 99, 132, 0.8)', 'rgba(75, 192, 192, 0.8)'],
                borderColor: ['rgba(255, 99, 132, 1)', 'rgba(75, 192, 192, 1)'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
</script>

<%
    const today = new Date();
    const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
%>

<!-- Office Grid -->
<div class="row g-3">
    <% offices.forEach(office => {
        const booking = bookings.find(b => b.office_id?.toString() === office._id.toString());
        const isBooked = !!booking;
        const isExpiringSoon = isBooked && new Date(booking.end_date) >= today && new Date(booking.end_date) <= endOfMonth;

        if (filter === 'all' || (filter === 'available' && !isBooked) || (filter === 'booked' && isBooked)) { %>

        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
            <div class="office-box p-3 shadow-sm rounded d-flex flex-column justify-content-between <%= isBooked ? 'office-booked' : 'office-available' %>">

                <% if (isBooked) { %>
                    <a href="/bookings/view/<%= booking._id %>" class="text-decoration-none text-dark d-block flex-grow-1">
                <% } %>

                <div class="d-flex justify-content-end mb-2">
                    <span class="badge <%= isBooked ? 'bg-danger' : 'bg-success' %>">
                        <%= isBooked ? 'üî¥ Booked' : 'üü¢ Available' %>
                    </span>
                </div>

                <h5 class="fw-bold mb-2">Office <%= office.office_number %></h5>
                <p class="mb-1">üè¢ Floor: <%= office.floor || 'N/A' %></p>

                <% if (isExpiringSoon) { %>
                    <span class="badge bg-warning text-dark mb-2">‚ö†Ô∏è Expires This Month</span>
                <% } %>

                <% if (isBooked) { %>
                    <p class="mb-1"><strong>Booked by:</strong> <%= booking.client_id?.company_en || booking.client_id?.name || 'N/A' %></p>

                    <% if (inspectionStatusMap && inspectionStatusMap[booking._id.toString()] !== undefined) { %>
                        <div class="remaining-inspections">
                            üõ°Ô∏è <%= inspectionStatusMap[booking._id.toString()] %> free inspections remaining
                        </div>
                    <% } %>

                    <p class="mb-1"><strong>From:</strong> <%= new Date(booking.start_date).toISOString().split('T')[0] %></p>
                    <p class="mb-1"><strong>To:</strong> <%= new Date(booking.end_date).toISOString().split('T')[0] %></p>
                <% } %>

                <% if (isBooked) { %></a><% } %>

                <% if (!isBooked) { %>
                    <div class="d-grid mt-3">
                        <a href="/bookings/new/<%= office._id %>" class="btn btn-sm btn-outline-primary fw-bold">üöÄ Book Now</a>
                    </div>
                <% } %>

            </div>
        </div>

    <% } }); %>
</div>

<!-- Styling -->
<style>
    .office-box {
        border: 2px solid #e0e0e0;
        border-radius: 16px;
        background-color: #fff;
        transition: all 0.3s ease;
        height: 260px;
    }

    .office-available {
        background-color: #e8f5e9;
        border-color: #81c784;
    }

    .office-booked {
        background-color: #fff3f3;
        border-color: #e57373;
    }

    .office-box:hover {
        border-color: #0d6efd;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-4px);
    }
</style>

<%- include('partials/footer') %>
