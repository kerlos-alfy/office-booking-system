
<%- include('partials/header') %>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-primary">📋 Booking Overview</h1>
    <div>
      <a href="/bookings" class="btn btn-outline-secondary me-2">🔙 Back</a>
      <button class="btn btn-outline-primary" onclick="window.print()">🖨️ Print</button>
    </div>
  </div>

  <div class="card shadow-lg border-0 mb-4">
    <div class="card-header bg-dark text-white">
      <h5 class="mb-0">📄 Contract & Client Info</h5>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-6">
          <p><strong>🏢 Office:</strong> <%= booking.office_id?.office_number %></p>
          <p><strong>📍 Branch:</strong> <%= booking.office_id?.branch_id?.name %></p>
          <p><strong>👤 Client:</strong> <%= booking.client_id?.registered_owner_name || booking.client_id?.company_en || booking.client_id?.name || booking.client_id?.email || 'N/A' %></p>
        </div>
        <div class="col-md-6">
          <p><strong>📅 From:</strong> <%= new Date(booking.start_date).toISOString().split('T')[0] %></p>
          <p><strong>📅 To:</strong> <%= new Date(booking.end_date).toISOString().split('T')[0] %></p>
          <p><strong>📄 Page No:</strong> <%= booking.page_no %></p>
          <p><strong>📌 Status:</strong> <span class="badge <%= booking.status === 'archived' ? 'bg-secondary' : 'bg-success' %>"><%= booking.status === 'archived' ? 'Archived' : 'Active' %></span></p>
        </div>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <a href="/bookings/<%= booking._id %>/generate-contract" class="btn btn-success">📄 Contract</a>
        <a href="/bookings/<%= booking._id %>/generate-contract" class="btn btn-warning">🧾 Tax Invoice</a>
        <a href="/bookings/<%= booking._id %>/tax-invoice" class="btn btn-dark" target="_blank">🧾 Tax Invoice</a>
      </div>
    </div>
  </div>

  <!-- Rest of the page content unchanged until cheque section -->

  <!-- ✅ جدول الشيكات -->
  <div class="card shadow-sm mb-5">
    <div class="card-header bg-light">
      <h5 class="mb-0 text-primary">💳 Cheque Installments</h5>
    </div>
    <div class="card-body px-4">
      <% if (booking.cheques && booking.cheques.length > 0) { %>
        <% const now = new Date(); %>
        <div class="table-responsive">
          <table class="table table-bordered text-center align-middle">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>Due Date</th>
                <th>Amount (AED)</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <% booking.cheques.forEach((cheque, index) => {
                const due = new Date(cheque.due_date);
                let rowClass = "";

                if (cheque.collected) {
                  rowClass = "table-success";
                } else if (due < now) {
                  rowClass = "table-danger";
                } else if (due.getMonth() === now.getMonth() && due.getFullYear() === now.getFullYear()) {
                  rowClass = "table-warning";
                }
              %>
              <tr class="<%= rowClass %>">
                <td><%= index + 1 %></td>
                <td><%= due.toLocaleDateString() %></td>
                <td><%= cheque.amount.toFixed(2) %></td>
                <td>
                  <% if (cheque.collected) { %>
                    ✅ Collected
                    <br>
                    <small class="text-muted">
                      <%= cheque.collected_at ? new Date(cheque.collected_at).toLocaleDateString() : '' %>
                    </small>
                    <% if (cheque.note) { %>
                      <br><span class="text-info fst-italic"><%= cheque.note %></span>
                    <% } %>
                  <% } else if (due < now) { %>
                    ⚠️ Overdue
                  <% } else if (
                    due.getMonth() === now.getMonth() &&
                    due.getFullYear() === now.getFullYear()
                  ) { %>
                    ⏳ This Month
                  <% } else { %>
                    🗓️ Upcoming
                  <% } %>
                </td>
                <td>
                  <% if (!cheque.collected) { %>
                    <form action="/bookings/<%= booking._id %>/cheques/<%= index %>/mark-collected" method="POST" class="d-flex gap-1 flex-wrap">
                      <input type="text" name="note" class="form-control form-control-sm" placeholder="Add note..." />
                      <button class="btn btn-success btn-sm">✔ Mark as Collected</button>
                    </form>
                  <% } else { %>
                    —
                  <% } %>
                </td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <p class="text-muted">No cheques scheduled for this booking.</p>
      <% } %>
    </div>
  </div>

<%- include('partials/footer') %>
